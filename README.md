# spiffe-helper-rust

A Rust implementation of spiffe-helper.

spiffe-helper fetches SPIFFE X.509 certificates and JWT tokens from the SPIRE agent. It acts as a bridge to integrate other programs with SPIRE.

## Tooling

This repository depends on several CLI tools (`kind`, `kubectl`, `helm`, `jq`, and `openssl`). We do **not** download or pin binary releases for you; instead, we provide a quick verification script so you can continue using whatever versions your package manager supplies.

### Verify prerequisites (`make tools`)

Run the following to confirm the required CLIs are present on your `PATH`:

```bash
make tools
```

The `tools` target runs `scripts/install-tools.sh`, which now **only checks** for the tools and prints their versions. If something is missing, the script exits with a failure code and echoes the upstream installation link so you can install/upgrade the tool yourself. Re-run `make tools` after installing to ensure everything is available.

### Installing the tools

Use whichever package manager you prefer. The examples below are common starting points; consult the official docs if you need additional options or platforms.

| Tool    | Homebrew (macOS)                   | Debian/Ubuntu (apt/snap/other)                 | Docs |
| ------- | ---------------------------------- | ---------------------------------------------- | ---- |
| kind    | `brew install kind`                | `GO111MODULE=on go install sigs.k8s.io/kind@latest` | https://kind.sigs.k8s.io/docs/user/quick-start/#installation |
| kubectl | `brew install kubectl`             | `sudo apt-get install -y kubectl`              | https://kubernetes.io/docs/tasks/tools/ |
| helm    | `brew install helm`                | `curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 \| bash` | https://helm.sh/docs/intro/install/ |
| jq      | `brew install jq`                  | `sudo apt-get install -y jq`                   | https://jqlang.github.io/jq/download/ |
| openssl | `brew install openssl`             | `sudo apt-get install -y openssl`              | https://www.openssl.org/source/ |

Feel free to substitute other installation methods (ASDF, Nix, direct downloads, etc.) as long as the resulting binaries land on your `PATH`. After installation, run `make tools` again to verify the environment.

## Certificate Generation

> **⚠️ IMPORTANT: Testing Only**  
> The certificates and keys generated by `make certs` are **for testing and development purposes only**. They should **never** be used in production environments.
>
> For production deployments, use properly managed certificate authorities (CAs) and follow your organization's security policies for key generation, rotation, and storage.

### Generate SPIRE Certificates (`make certs`)

This repository includes a script to generate local SPIRE-related certificates and keys for testing:

```bash
make certs
```

This command creates the following files in `./artifacts/certs/`:

- **CA Certificate and Key**: `ca-cert.pem`, `ca-key.pem` (ECDSA P-384)
- **SPIRE Server Certificate and Key**: `spire-server-cert.pem`, `spire-server-key.pem` (ECDSA P-256)
- **SPIRE Server Certificate Signing Request**: `spire-server.csr` (for reference)
- **Bootstrap Bundle**: `bootstrap-bundle.pem` (contains the CA certificate)

All certificates use **ECDSA** (Elliptic Curve Digital Signature Algorithm) for modern cryptographic security with smaller key sizes and better performance compared to RSA.

The `make certs` target is **idempotent**: running it multiple times will skip generation if the files already exist. To regenerate all certificates, first run `make clean` to remove the existing files.

### Clean Generated Certificates (`make clean`)

To remove all generated certificates:

```bash
make clean
```

This removes the `./artifacts/certs/` directory and all its contents. The `artifacts/` directory is gitignored, so generated certificates will never be committed to the repository.

## Local kind cluster

Use the provided `kind-config.yaml` plus Make targets to spin up a disposable development cluster without touching your global kubeconfig:

1. Run `make cluster-up`. The command creates (or reuses) a kind cluster named `spiffe-helper` and writes a kubeconfig to `./artifacts/kubeconfig`.
2. Point `kubectl` at the new cluster with `export KUBECONFIG=$(pwd)/artifacts/kubeconfig` and interact as usual.
3. Tear the cluster down with `make cluster-down`. This automatically cleans up SPIRE agents and server resources, then removes the kind cluster and cleans up the kubeconfig under `./artifacts/`.

Both targets are idempotent: re-running `make cluster-up` when the cluster already exists refreshes the kubeconfig; `make cluster-down` is a no-op if the cluster is already gone. The `artifacts/` directory is gitignored so kubeconfigs remain local-only.

## SPIRE Server Deployment

This repository includes Kubernetes manifests and Makefile targets to deploy a SPIRE server in the kind cluster for testing and development.

### Deploy SPIRE Server (`make deploy-spire-server`)

Deploys the SPIRE server with all required resources:

```bash
make deploy-spire-server
```

This target:
- Ensures the cluster is running (`make cluster-up`)
- Ensures certificates are generated (`make certs`)
- Creates the `spire-server` namespace
- Creates Kubernetes Secrets from certificates in `./artifacts/certs/`
- Deploys the SPIRE server StatefulSet with:
  - SQLite datastore
  - Kubernetes node attestation (k8s_psat plugin)
  - Health probes (TCP socket checks on port 8081)
- Waits for the pod to be ready before returning

The deployment is **idempotent**: safe to run multiple times.

### Check SPIRE Server Status (`make check-spire-server`)

Verify the SPIRE server is running and healthy:

```bash
make check-spire-server
```

This displays:
- Pod status
- Service status
- Recent logs (last 20 lines)
- Health check status

### Undeploy SPIRE Server (`make undeploy-spire-server`)

Remove all SPIRE server resources:

```bash
make undeploy-spire-server
```

This cleanly removes the namespace and all associated resources.

### Testing

After deployment, verify the server is running:

```bash
# Check pod status
export KUBECONFIG=$(pwd)/artifacts/kubeconfig
kubectl get pods -n spire-server

# View logs
kubectl logs -n spire-server -l app=spire-server -f

# Check service
kubectl get svc -n spire-server
```

The SPIRE server:
- Runs on port 8081 (API endpoint)
- Uses SPIRE server image version 1.13.0
- Trust domain: `spiffe-helper.local`
- Stores data in SQLite (ephemeral, cleared on pod restart)

## SPIRE Agent Deployment

This repository includes Kubernetes manifests and Makefile targets to deploy SPIRE agents as a DaemonSet in the kind cluster. The agents run on every node and provide the Workload API for workloads to fetch SPIFFE identities.

### Deploy SPIRE Agent (`make deploy-spire-agent`)

Deploys SPIRE agents as a DaemonSet with all required resources:

```bash
make deploy-spire-agent
```

This target:
- Ensures certificates are generated (`make certs`)
- Creates the `spire-agent` namespace
- Creates a Kubernetes Secret from the bootstrap bundle in `./artifacts/certs/`
- Deploys the SPIRE agent DaemonSet with:
  - Kubernetes node attestation (k8s_psat plugin)
  - Workload API socket at `/run/spire/sockets/workload_api.sock`
  - Proper RBAC (ClusterRole and ClusterRoleBinding) for node attestation
- Waits for all agent pods to be ready before returning

The deployment is **idempotent**: safe to run multiple times.

### Undeploy SPIRE Agent (`make undeploy-spire-agent`)

Remove all SPIRE agent resources:

```bash
make undeploy-spire-agent
```

This cleanly removes the namespace and all associated resources (DaemonSet, ConfigMap, ClusterRole, ClusterRoleBinding, ServiceAccount, and Secrets).

### Testing

After deployment, verify the agents are running:

```bash
# Check DaemonSet status
export KUBECONFIG=$(pwd)/artifacts/kubeconfig
kubectl get daemonset -n spire-agent

# View agent pods
kubectl get pods -n spire-agent

# View logs from a specific agent pod
kubectl logs -n spire-agent -l app=spire-agent -f

# Check agent readiness
kubectl get pods -n spire-agent -o wide
```

The SPIRE agents:
- Run as a DaemonSet (one pod per node)
- Use SPIRE agent image version 1.13.0 (matches server version)
- Trust domain: `spiffe-helper.local` (matches server)
- Provide Workload API at `/run/spire/sockets/workload_api.sock`
- Use Kubernetes node attestation to authenticate with the SPIRE server
- Automatically attest and become ready after successful node attestation

### Complete Deployment Workflow

To deploy both SPIRE server and agents:

```bash
# 1. Generate certificates
make certs

# 2. Create cluster and deploy server
make deploy-spire-server

# 3. Deploy agents
make deploy-spire-agent
```

To clean up everything:

```bash
# This automatically cleans up agents, server, and the cluster
make cluster-down
```

## Environment Orchestration

### Complete Environment Setup (`make env-up`)

Sets up the entire development environment in one command:

```bash
make env-up
```

This target orchestrates:
1. Verifies required tools are installed (`make tools`)
2. Generates certificates (`make certs`)
3. Creates the kind cluster (`make cluster-up`)
4. Deploys SPIRE server (`make deploy-spire-server`)
5. Deploys SPIRE agents (`make deploy-spire-agent`)
6. Deploys workload registrations (`make deploy-registration`)

### Complete Environment Teardown (`make env-down`)

Tears down the entire environment:

```bash
make env-down
```

This target:
1. Removes workload registrations (`make undeploy-registration`)
2. Removes SPIRE agents (`make undeploy-spire-agent`)
3. Removes SPIRE server (`make undeploy-spire-server`)
4. Deletes the kind cluster (`make cluster-down`)
5. Cleans generated artifacts (`make clean`)

## Validation and Testing

### Smoke Test (`make smoke-test`)

Validates that the SPIRE environment is healthy and functioning correctly:

```bash
make smoke-test
```

This target runs comprehensive health checks:
- **Cluster Connectivity**: Verifies the Kubernetes cluster is accessible
- **SPIRE Server Pod Status**: Checks that the server pod exists and is Ready
- **SPIRE Server Health**: Verifies container readiness (health probes passed) and service exists
- **SPIRE Agent DaemonSet Status**: Verifies all agent pods are ready
- **SPIRE Agent Health**: Verifies agent pod readiness
- **Agent-Server Communication**: Verifies agents can communicate with the server (checks logs for successful attestation)

The smoke test will exit with a non-zero status code if any checks fail, making it suitable for CI/CD pipelines.

**Example usage after environment setup:**

```bash
# Set up the environment
make env-up

# Validate everything is working
make smoke-test

# If smoke-test passes, the environment is ready for development
```

## Troubleshooting

### Common Issues

#### Cluster Not Found

**Error**: `kind cluster 'spiffe-helper' does not exist`

**Solution**: Run `make cluster-up` to create the cluster.

#### Certificates Missing

**Error**: `CA certificate files not found`

**Solution**: Run `make certs` to generate the required certificates.

#### SPIRE Server Not Ready

**Symptoms**: Pod exists but is not in Ready state

**Diagnosis**:
```bash
export KUBECONFIG=$(pwd)/artifacts/kubeconfig
kubectl get pods -n spire-server
kubectl logs -n spire-server -l app=spire-server
```

**Common causes**:
- Server is still starting up (wait a few minutes)
- Certificate issues (check logs for certificate errors)
- Port conflicts (ensure port 8081 is available)

#### SPIRE Agent Not Attesting

**Symptoms**: Agent pods are running but not ready

**Diagnosis**:
```bash
export KUBECONFIG=$(pwd)/artifacts/kubeconfig
kubectl get pods -n spire-agent
kubectl logs -n spire-agent -l app=spire-agent
```

**Common causes**:
- Server not ready (ensure server is healthy first)
- Bootstrap bundle mismatch (regenerate certificates with `make clean && make certs`)
- RBAC issues (check ClusterRole and ClusterRoleBinding)

#### Smoke Test Failures

If `make smoke-test` fails:

1. **Check component status individually**:
   ```bash
   make check-spire-server
   kubectl get pods -n spire-agent
   ```

2. **Review logs**:
   ```bash
   export KUBECONFIG=$(pwd)/artifacts/kubeconfig
   kubectl logs -n spire-server -l app=spire-server
   kubectl logs -n spire-agent -l app=spire-agent
   ```

3. **Verify certificates**:
   ```bash
   ls -la artifacts/certs/
   ```

4. **Restart components**:
   ```bash
   make env-down
   make env-up
   make smoke-test
   ```

### Manual Verification Steps

After deployment, you can manually verify the environment:

```bash
export KUBECONFIG=$(pwd)/artifacts/kubeconfig

# Check server pod status and logs
kubectl get pods -n spire-server
kubectl logs -n spire-server spire-server-0

# Check agent pod status and logs
kubectl get pods -n spire-agent
kubectl logs -n spire-agent <agent-pod-name>

# List registered entries
kubectl exec -n spire-server spire-server-0 -- spire-server entry show
```

## Important Notes

### Generated Files and Git Policy

**⚠️ CRITICAL: Never commit generated files to git**

This repository uses `.gitignore` to exclude generated artifacts:

- **Certificates and keys** (`./artifacts/certs/`) - Contains sensitive cryptographic material
- **Kubeconfig files** (`./artifacts/kubeconfig`) - Contains cluster access credentials
- **Build artifacts** (`./target/`, `./bin/`) - Contains compiled binaries

**All generated files live under gitignored directories and must not be committed.**

The following directories are gitignored:
- `/artifacts/` - All certificates, keys, and kubeconfig files
- `/target/` - Rust build artifacts
- `/bin/` - Compiled binaries

**Before committing**, always verify:
```bash
git status
```

If you see any files from the above directories, **do not commit them**. They are intentionally excluded for security and cleanliness.

### Certificate Security

The certificates generated by `make certs` are:
- **For testing and development only**
- **Never use in production**
- **Generated locally and not shared**
- **Automatically excluded from git**

For production deployments, use properly managed certificate authorities (CAs) and follow your organization's security policies.

## Make Targets Reference

| Target | Description | Dependencies |
|--------|-------------|--------------|
| `tools` | Verify required CLI tools are installed | None |
| `certs` | Generate SPIRE certificates for testing | None |
| `clean` | Remove all generated artifacts | None |
| `cluster-up` | Create or refresh kind cluster | `kind-config.yaml` |
| `cluster-down` | Delete kind cluster and cleanup | None |
| `check-cluster` | Verify cluster exists and is accessible | None |
| `check-certs` | Verify required certificates exist | None |
| `deploy-spire-server` | Deploy SPIRE server to cluster | `cluster-up`, `certs` |
| `undeploy-spire-server` | Remove SPIRE server from cluster | None |
| `check-spire-server` | Display SPIRE server status | `check-cluster` |
| `deploy-spire-agent` | Deploy SPIRE agents as DaemonSet | `certs` |
| `undeploy-spire-agent` | Remove SPIRE agents from cluster | None |
| `deploy-registration` | Register workload entries | `check-cluster` |
| `undeploy-registration` | Remove workload registrations | None |
| `smoke-test` | Validate SPIRE environment health | `check-cluster` |
| `env-up` | Complete environment setup | `tools`, `certs`, `cluster-up`, `deploy-spire-server`, `deploy-spire-agent`, `deploy-registration` |
| `env-down` | Complete environment teardown | `undeploy-registration`, `undeploy-spire-agent`, `undeploy-spire-server`, `cluster-down`, `clean` |
