# spiffe-helper-rust

A Rust implementation of spiffe-helper.

spiffe-helper fetches SPIFFE X.509 certificates and JWT tokens from the SPIRE agent. It acts as a bridge to integrate other programs with SPIRE.

## Tooling

This repository depends on several CLI tools (`kind`, `kubectl`, `helm`, `jq`, and `openssl`). We do **not** download or pin binary releases for you; instead, we provide a quick verification script so you can continue using whatever versions your package manager supplies.

### Verify prerequisites (`make tools`)

Run the following to confirm the required CLIs are present on your `PATH`:

```bash
make tools
```

The `tools` target runs `scripts/install-tools.sh`, which now **only checks** for the tools and prints their versions. If something is missing, the script exits with a failure code and echoes the upstream installation link so you can install/upgrade the tool yourself. Re-run `make tools` after installing to ensure everything is available.

### Installing the tools

Use whichever package manager you prefer. The examples below are common starting points; consult the official docs if you need additional options or platforms.

| Tool    | Homebrew (macOS)                   | Debian/Ubuntu (apt/snap/other)                 | Docs |
| ------- | ---------------------------------- | ---------------------------------------------- | ---- |
| kind    | `brew install kind`                | `GO111MODULE=on go install sigs.k8s.io/kind@latest` | https://kind.sigs.k8s.io/docs/user/quick-start/#installation |
| kubectl | `brew install kubectl`             | `sudo apt-get install -y kubectl`              | https://kubernetes.io/docs/tasks/tools/ |
| helm    | `brew install helm`                | `curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 \| bash` | https://helm.sh/docs/intro/install/ |
| jq      | `brew install jq`                  | `sudo apt-get install -y jq`                   | https://jqlang.github.io/jq/download/ |
| openssl | `brew install openssl`             | `sudo apt-get install -y openssl`              | https://www.openssl.org/source/ |

Feel free to substitute other installation methods (ASDF, Nix, direct downloads, etc.) as long as the resulting binaries land on your `PATH`. After installation, run `make tools` again to verify the environment.

## Certificate Generation

> **⚠️ IMPORTANT: Testing Only**  
> The certificates and keys generated by `make certs` are **for testing and development purposes only**. They should **never** be used in production environments.
>
> For production deployments, use properly managed certificate authorities (CAs) and follow your organization's security policies for key generation, rotation, and storage.

### Generate SPIRE Certificates (`make certs`)

This repository includes a script to generate local SPIRE-related certificates and keys for testing:

```bash
make certs
```

This command creates the following files in `./artifacts/certs/`:

- **CA Certificate and Key**: `ca-cert.pem`, `ca-key.pem` (ECDSA P-384)
- **SPIRE Server Certificate and Key**: `spire-server-cert.pem`, `spire-server-key.pem` (ECDSA P-256)
- **SPIRE Server Certificate Signing Request**: `spire-server.csr` (for reference)
- **Bootstrap Bundle**: `bootstrap-bundle.pem` (contains the CA certificate)

All certificates use **ECDSA** (Elliptic Curve Digital Signature Algorithm) for modern cryptographic security with smaller key sizes and better performance compared to RSA.

The `make certs` target is **idempotent**: running it multiple times will skip generation if the files already exist. To regenerate all certificates, first run `make clean` to remove the existing files.

### Clean Generated Certificates (`make clean`)

To remove all generated certificates:

```bash
make clean
```

This removes the `./artifacts/certs/` directory and all its contents. The `artifacts/` directory is gitignored, so generated certificates will never be committed to the repository.

## Local kind cluster

Use the provided `kind-config.yaml` plus Make targets to spin up a disposable development cluster without touching your global kubeconfig:

1. Run `make cluster-up`. The command creates (or reuses) a kind cluster named `spiffe-helper` and writes a kubeconfig to `./artifacts/kubeconfig`.
2. Point `kubectl` at the new cluster with `export KUBECONFIG=$(pwd)/artifacts/kubeconfig` and interact as usual.
3. Tear the cluster down with `make cluster-down`. This removes the kind cluster and cleans up the kubeconfig under `./artifacts/`.

Both targets are idempotent: re-running `make cluster-up` when the cluster already exists refreshes the kubeconfig; `make cluster-down` is a no-op if the cluster is already gone. The `artifacts/` directory is gitignored so kubeconfigs remain local-only.

## SPIRE Server Deployment

This repository includes Kubernetes manifests and Makefile targets to deploy a SPIRE server in the kind cluster for testing and development.

### Deploy SPIRE Server (`make deploy-spire-server`)

Deploys the SPIRE server with all required resources:

```bash
make deploy-spire-server
```

This target:
- Ensures the cluster is running (`make cluster-up`)
- Ensures certificates are generated (`make certs`)
- Creates the `spire-server` namespace
- Creates Kubernetes Secrets from certificates in `./artifacts/certs/`
- Deploys the SPIRE server StatefulSet with:
  - SQLite datastore
  - Kubernetes node attestation (k8s_psat plugin)
  - Health probes (TCP socket checks on port 8081)
- Waits for the pod to be ready before returning

The deployment is **idempotent**: safe to run multiple times.

### Check SPIRE Server Status (`make check-spire-server`)

Verify the SPIRE server is running and healthy:

```bash
make check-spire-server
```

This displays:
- Pod status
- Service status
- Recent logs (last 20 lines)
- Health check status

### Undeploy SPIRE Server (`make undeploy-spire-server`)

Remove all SPIRE server resources:

```bash
make undeploy-spire-server
```

This cleanly removes the namespace and all associated resources.

### Testing

After deployment, verify the server is running:

```bash
# Check pod status
export KUBECONFIG=$(pwd)/artifacts/kubeconfig
kubectl get pods -n spire-server

# View logs
kubectl logs -n spire-server -l app=spire-server -f

# Check service
kubectl get svc -n spire-server
```

The SPIRE server:
- Runs on port 8081 (API endpoint)
- Uses SPIRE server image version 1.13.0
- Trust domain: `spiffe-helper.local`
- Stores data in SQLite (ephemeral, cleared on pod restart)
